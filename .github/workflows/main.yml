name: Blinko Intel Smart Builder

on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch:
    inputs:
      manual_version:
        description: '输入官方 Release 的 Tag (例如 1.8.4 或 v1.8.4)。留空则自动抓取最新正式版。'
        required: false
        default: ''
      force_build:
        description: '强制重新构建当前版本'
        type: boolean
        default: false

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      target_tag: ${{ steps.check.outputs.target_tag }}
    steps:
      - name: 1. 跨仓库版本对账
        id: check
        run: |
          # 明确指向你提供的官方仓库 [cite: 2026-02-01]
          REPO="blinkospace/blinko"
          
          if [ -z "${{ github.event.inputs.manual_version }}" ]; then
            # 仅获取最新的 Release Tag，完全不看 Branch [cite: 2026-02-01]
            TARGET_TAG=$(curl -s https://api.github.com/repos/$REPO/releases/latest | jq -r .tag_name)
          else
            # 手动指定时，自动补全 v 前缀
            INPUT="${{ github.event.inputs.manual_version }}"
            [[ $INPUT != v* ]] && TARGET_TAG="v$INPUT" || TARGET_TAG="$INPUT"
          fi
          
          echo "判定目标 Tag: $TARGET_TAG"
          
          # 检查你的仓库是否已有该版本的 Intel 包 [cite: 2026-02-01]
          CHECK_URL="https://api.github.com/repos/${{ github.repository }}/releases/tags/${TARGET_TAG}-intel"
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" $CHECK_URL)
          
          if [ "$STATUS" != "200" ] || [ "${{ github.event.inputs.force_build }}" == "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "target_tag=$TARGET_TAG" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build-intel-mac:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: macos-15-intel 
    permissions:
      contents: write

    steps:
      - name: 1. 检出官方代码 (通过 Tag 定位)
        uses: actions/checkout@v4
        with:
          repository: blinkospace/blinko
          ref: ${{ needs.check-version.outputs.target_tag }}
          fetch-depth: 1

      - name: 2. 注入 Monterey 兼容性补丁 (解决白屏)
        run: |
          # 强制将构建目标从 esnext 降级为 es2015
          # 解决 2017 款 MBP (12.7.6) 的正则解析报错
          find . -maxdepth 4 -name "vite.config.ts" -exec sed -i '' 's/target: "esnext"/target: ["es2015", "safari13"]/g' {} +
          find . -maxdepth 4 -name "tsconfig.json" -exec sed -i '' 's/"target": "esnext"/"target": "es2015"/g' {} +

      - name: 3. 构建与打包
        run: |
          bun install --frozen-lockfile
          cd app
          # 写入版本号并执行低版本兼容构建 [cite: 2026-02-01]
          VERSION_NUM=$(echo "${{ needs.check-version.outputs.target_tag }}" | sed 's/^v//')
          jq ".version = \"$VERSION_NUM\"" src-tauri/tauri.conf.json > tmp.json && mv tmp.json src-tauri/tauri.conf.json
          
          export VITE_BUILD_TARGET=es2015
          bun run build:no-pwa
          bun run tauri build --target x86_64-apple-darwin || true

      - name: 4. 自动发布 Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-version.outputs.target_tag }}-intel
          name: "Blinko ${{ needs.check-version.outputs.target_tag }} (Intel Mac)"
          body: |
            Blinko 官方 Release 版本：${{ needs.check-version.outputs.target_tag }}
            - 适配环境：macOS Monterey 12.7.6
            - 修复问题：白屏 SyntaxError (正则命名分组)
          files: app/src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
