name: Blinko Intel Client Builder

on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch: 
    inputs:
      version:
        description: '想要构建的特定版本号 (例如 v1.8.4)'
        required: false
        default: 'latest'

jobs:
  build-intel-mac:
    runs-on: macos-15-intel 
    permissions:
      contents: write

    steps:
      - name: 1. 获取目标版本号
        id: get_tag
        run: |
          if [[ "${{ github.event.inputs.version }}" == "latest" || "${{ github.event.inputs.version }}" == "" ]]; then
            FULL_TAG=$(curl -s https://api.github.com/repos/blinkospace/blinko/releases/latest | jq -r .tag_name)
          else
            FULL_TAG="${{ github.event.inputs.version }}"
          fi
          echo "full_tag=$FULL_TAG" >> $GITHUB_OUTPUT
          echo "version_num=$(echo $FULL_TAG | sed 's/^v//')" >> $GITHUB_OUTPUT

      - name: 2. 检出官方源码
        uses: actions/checkout@v4
        with:
          repository: blinkospace/blinko
          ref: ${{ steps.get_tag.outputs.full_tag }}
          fetch-depth: 1

      - name: 3. 安装 Bun 环境
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.2.8 

      - name: 4. 安装 Rust (Intel 架构)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: 5. 注入版本号
        run: |
          cd app
          jq '.version = "${{ steps.get_tag.outputs.version_num }}"' src-tauri/tauri.conf.json > tmp.json && mv tmp.json src-tauri/tauri.conf.json

      - name: 6. 安装依赖与构建前端
        run: |
          bun install --frozen-lockfile
          cd app
          bun run build:no-pwa

      - name: 7. 执行 Tauri 构建 (手动模式)
        # 我们不再使用 tauri-action，直接运行命令，即使报错也继续下一步
        continue-on-error: true 
        run: |
          cd app
          # 加上这个环境变量可以跳过一些严格的检查
          export CI=true
          bun run tauri build --target x86_64-apple-darwin

      - name: 8. 归档 DMG 产物 (核心步骤)
        # 这一步会直接从编译目录里把 DMG 捞出来
        uses: actions/upload-artifact@v4
        with:
          name: Blinko-${{ steps.get_tag.outputs.full_tag }}-Intel-Mac
          path: |
            app/src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
            app/src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz
          if-no-files-found: error
