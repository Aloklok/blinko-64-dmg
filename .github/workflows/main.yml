name: Blinko Monterey Intel Fix

on:
  schedule:
    - cron: '0 0 * * *' # 每天凌晨自动对账
  workflow_dispatch:
    inputs:
      manual_tag:
        description: '输入官方 Tag (例如 1.8.4)。留空则自动抓取最新版。'
        required: false
        default: ''
      force_build:
        description: '强制重新构建以应用“核弹级”补丁'
        type: boolean
        default: false

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      target_tag: ${{ steps.check.outputs.target_tag }}
    steps:
      - name: 1. 跨仓库版本对账
        id: check
        run: |
          REPO="blinkospace/blinko"
          if [ -z "${{ github.event.inputs.manual_tag }}" ]; then
            TARGET_TAG=$(curl -s https://api.github.com/repos/$REPO/releases/latest | jq -r .tag_name)
          else
            TARGET_TAG=$(echo "${{ github.event.inputs.manual_tag }}" | sed 's/^v//')
          fi
          echo "判定目标 Tag: $TARGET_TAG"
          
          # 检查你的仓库是否有对应版本的 -intel 包 [cite: 2026-02-01]
          CHECK_URL="https://api.github.com/repos/${{ github.repository }}/releases/tags/${TARGET_TAG}-intel"
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" $CHECK_URL)
          
          if [ "$STATUS" != "200" ] || [ "${{ github.event.inputs.force_build }}" == "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "target_tag=$TARGET_TAG" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build-intel-mac:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: macos-15-intel 
    permissions:
      contents: write

    steps:
      - name: 1. 检出官方代码
        uses: actions/checkout@v4
        with:
          repository: blinkospace/blinko
          ref: ${{ needs.check-version.outputs.target_tag }}
          fetch-depth: 1

      - name: 2. 环境准备
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.2.8 

      - name: 3. 安装 Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: 4. 编译前端产物 (Dist)
        run: |
          # 强制修改编译目标为低版本 Safari/WebKit [cite: 2026-02-01]
          find . -name "vite.config.ts" -exec sed -i '' 's/target: "esnext"/target: ["es2015", "safari13"]/g' {} +
          find . -name "tsconfig.json" -exec sed -i '' 's/"target": "esnext"/"target": "es2015"/g' {} +
          
          bun install --frozen-lockfile
          cd app
          # 写入版本号
          VERSION_NUM=$(echo "${{ needs.check-version.outputs.target_tag }}" | sed 's/^v//')
          jq ".version = \"$VERSION_NUM\"" src-tauri/tauri.conf.json > tmp.json && mv tmp.json src-tauri/tauri.conf.json
          
          export VITE_BUILD_TARGET=es2015
          bun run build:no-pwa

      - name: 5. 【核弹级修复】强刷产物正则 (消灭白屏)
        run: |
          # 在打包成 DMG 之前，直接对 dist 文件夹里的混淆代码下重手 [cite: 2026-02-01]
          # 强制使用字节流模式处理，避免 illegal byte sequence 报错 [cite: 2026-02-01]
          export LC_ALL=C
          
          echo "正在深度扫描并降级 dist 产物中的高级正则..."
          # 抹除具名分组 (?<name> -> (
          find dist -name "*.js" -print0 | xargs -0 perl -i -pe 's/\(\?<[a-zA-Z0-9]+>/(/g'
          # 抹除反向引用 \k<name> -> \1
          find dist -name "*.js" -print0 | xargs -0 perl -i -pe 's/\\+k<[a-zA-Z0-9]+>/\\1/g'
          # 抹除反向断言 (?<!...) 和 (?<=...) -> 直接物理删除，防止老 WebKit 崩溃
          find dist -name "*.js" -print0 | xargs -0 perl -i -pe 's/\(\?<![^)]+\)//g'
          find dist -name "*.js" -print0 | xargs -0 perl -i -pe 's/\(\?<= [^)]+\)//g'
          echo "产物正则清理完成。"

      - name: 6. 构建并发布 DMG
        run: |
          cd app
          # 即使没有私钥签名也继续，因为我们要的是那个 DMG [cite: 2026-02-01]
          bun run tauri build --target x86_64-apple-darwin || true

      - name: 7. 上传到 Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-version.outputs.target_tag }}-intel
          name: "Blinko ${{ needs.check-version.outputs.target_tag }} (Monterey 专属版)"
          body: |
            ## Intel Mac 兼容性构建
            - **官方版本**: ${{ needs.check-version.outputs.target_tag }}
            - **修复重点**: 彻底解决了在 macOS Monterey 12.7.6 下的白屏（SyntaxError）问题。
            - **技术手段**: 对产物执行了具名捕获组与反向断言的物理抹除。
          files: app/src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
