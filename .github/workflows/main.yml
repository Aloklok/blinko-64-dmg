name: Blinko Intel Client Builder

on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch: 
    inputs:
      version:
        description: '想要构建的特定版本号 (例如 1.8.4)'
        required: false
        default: 'latest'

jobs:
  build-intel-mac:
    # 修改点：使用了 2026 年推荐的最新 Intel 镜像
    runs-on: macos-15-intel 
    permissions:
      contents: write

    steps:
      - name: 1. 获取目标版本号
        id: get_version
        run: |
          if [[ "${{ github.event.inputs.version }}" == "latest" || "${{ github.event.inputs.version }}" == "" ]]; then
            VERSION=$(curl -s https://api.github.com/repos/blinkospace/blinko/releases/latest | jq -r .tag_name | sed 's/^v//')
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "目标构建版本: $VERSION"

      - name: 2. 拉取官方源码
        uses: actions/checkout@v4
        with:
          repository: blinkospace/blinko
          ref: v${{ steps.get_version.outputs.VERSION }}
          fetch-depth: 1

      - name: 3. 安装 Bun 环境
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.2.8 

      - name: 4. 安装 Rust (Intel 架构)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: 5. 注入版本号到配置
        run: |
          cd app
          jq '.version = "${{ steps.get_version.outputs.VERSION }}"' src-tauri/tauri.conf.json > tmp.json && mv tmp.json src-tauri/tauri.conf.json

      - name: 6. 安装依赖与构建前端
        run: |
          bun install --frozen-lockfile
          cd app
          bun run build:no-pwa

      - name: 7. 执行 Tauri 构建 (无签名模式)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: 'app'
          args: '--target x86_64-apple-darwin'
          tagName: v${{ steps.get_version.outputs.VERSION }}-intel
          releaseName: 'Blinko ${{ steps.get_version.outputs.VERSION }} Intel Build'
          releaseBody: '为 Intel Mac 用户自制的二进制版本。'

      - name: 8. 归档 DMG 产物
        uses: actions/upload-artifact@v4
        with:
          name: Blinko-v${{ steps.get_version.outputs.VERSION }}-Intel-Mac
          path: app/src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
