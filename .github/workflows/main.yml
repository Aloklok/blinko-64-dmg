name: Blinko Intel Smart Builder

on:
  schedule:
    - cron: '0 0 * * *' # 每天检查一次
  workflow_dispatch: # 支持手动触发
    inputs:
      force_build:
        description: '是否强制重新构建当前版本？'
        type: boolean
        default: false

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      tag: ${{ steps.check.outputs.tag }}
    steps:
      - name: 检查官方版本与本地发布记录
        id: check
        run: |
          # 1. 获取官方最新 Tag
          UPSTREAM_TAG=$(curl -s https://api.github.com/repos/blinkospace/blinko/releases/latest | jq -r .tag_name)
          echo "官方最新版本: $UPSTREAM_TAG"
          
          # 2. 检查你自己的仓库里是否已经有了对应的 -intel 结尾的 Release
          # 注意：请确保你的仓库名和 GitHub API 路径匹配
          RESPONSE=$(curl -s -o /dev/null -I -w "%{http_code}" https://api.github.com/repos/${{ github.repository }}/releases/tags/${UPSTREAM_TAG}-intel)
          
          if [ "$RESPONSE" != "200" ] || [ "${{ github.event.inputs.force_build }}" == "true" ]; then
            echo "检测到新版本或强制构建，开始任务。"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          else
            echo "该版本已存在，跳过构建以节省时间。"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build-intel-mac:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: macos-15-intel 
    permissions:
      contents: write

    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4
        with:
          repository: blinkospace/blinko
          ref: ${{ needs.check-version.outputs.tag }}
          fetch-depth: 1

      - name: 2. 注入兼容性补丁 (修复白屏)
        run: |
          # 这一步是关键！
          # 在所有可能的 Vite/TS 配置中强制降级目标到 es2015 和 safari13
          # 这样能确保在 Monterey 的老 WebKit 上正常运行
          find . -name "vite.config.ts" -exec sed -i '' 's/target: "esnext"/target: ["es2015", "safari13"]/g' {} +
          find . -name "tsconfig.json" -exec sed -i '' 's/"target": "esnext"/"target": "es2015"/g' {} +
          echo "兼容性补丁注入完成。"

      - name: 3. 环境准备
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.2.8 

      - name: 4. 安装 Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: 5. 构建前端与 Tauri
        run: |
          bun install --frozen-lockfile
          cd app
          # 再次确保环境变量也指向旧版本
          export VITE_BUILD_TARGET=es2015
          bun run build:no-pwa
          # 即使签名报错也继续，因为我们需要 dmg 产物
          bun run tauri build --target x86_64-apple-darwin || true

      - name: 6. 发布到你的 Release 页面
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-version.outputs.tag }}-intel
          name: Blinko ${{ needs.check-version.outputs.tag }} Intel Mac 版
          body: |
            自动构建的 Intel Mac 兼容版本。
            适配系统：macOS Monterey (12.7.6) 及以上
            修复了老版本 WebKit 导致的白屏问题
          files: |
            app/src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
