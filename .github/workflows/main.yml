name: Blinko Intel Client Builder

on:
  schedule:
    - cron: '0 0 * * *' # 每天北京时间早上 8 点自动检查
  workflow_dispatch: # 支持手动触发
    inputs:
      version:
        description: '想要构建的特定版本号 (例如 v1.8.4)'
        required: false
        default: 'latest'

jobs:
  build-intel-mac:
    # 针对 2026 年环境，使用推荐的最新 Intel 镜像
    runs-on: macos-15-intel 
    permissions:
      contents: write

    steps:
      - name: 1. 精准获取官方 Tag
        id: get_tag
        run: |
          if [[ "${{ github.event.inputs.version }}" == "latest" || "${{ github.event.inputs.version }}" == "" ]]; then
            # 拿到原始 Tag，不再手动删除 'v'
            FULL_TAG=$(curl -s https://api.github.com/repos/blinkospace/blinko/releases/latest | jq -r .tag_name)
          else
            FULL_TAG="${{ github.event.inputs.version }}"
          fi
          # 同时保存带 v 的原始标签和不带 v 的版本号（用于 tauri.conf）
          echo "full_tag=$FULL_TAG" >> $GITHUB_OUTPUT
          echo "version_num=$(echo $FULL_TAG | sed 's/^v//')" >> $GITHUB_OUTPUT
          echo "准备构建的版本 Tag: $FULL_TAG"

      - name: 2. 检出官方源码 (使用全量 Tag)
        uses: actions/checkout@v4
        with:
          repository: blinkospace/blinko
          ref: ${{ steps.get_tag.outputs.full_tag }}
          # 增加 fetch-depth 确保能看到 tags
          fetch-depth: 1

      - name: 3. 安装 Bun 环境
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.2.8 

      - name: 4. 安装 Rust (Intel 架构)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: 5. 注入版本号到配置
        run: |
          cd app
          jq '.version = "${{ steps.get_tag.outputs.version_num }}"' src-tauri/tauri.conf.json > tmp.json && mv tmp.json src-tauri/tauri.conf.json

      - name: 6. 安装依赖与构建前端
        run: |
          bun install --frozen-lockfile
          cd app
          bun run build:no-pwa

      - name: 7. 执行 Tauri 构建 (无签名模式)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: 'app'
          args: '--target x86_64-apple-darwin'
          # 这里只出包，不自动创建新的 Release 免得污染你的仓库
          tagName: ${{ steps.get_tag.outputs.full_tag }}-intel
          releaseName: 'Blinko ${{ steps.get_tag.outputs.full_tag }} Intel Build'
          releaseBody: '为 2017/2019 款 Intel Mac 用户生成的二进制版本。'
          releaseDraft: true # 先存为草稿，方便你确认后再下载

      - name: 8. 归档 DMG 产物
        uses: actions/upload-artifact@v4
        with:
          name: Blinko-${{ steps.get_tag.outputs.full_tag }}-Intel-Mac
          path: app/src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
